CloudDrive Worker — UNIFIED CONSTITUTIONAL MASTER SPEC v7.33
(Execution-Aligned / Conflict-Free Edition) Date: 2026-02-15 Status:
Spec Freeze (Production 1.0)

============================================================ PART I —
CORE INVARIANTS (IMMUTABLE)
============================================================

1)  DOMAIN ID STRATEGY (FROZEN)

All domain identifiers MUST: - Be ULID - Length = 26 - Crockford Base32
(uppercase) - MUST NOT contain ‘:’

Domain IDs include: folder_id, card_id, asset_id, collection_id,
upload_session_id, file_id, audit_id

Only composite identifier allowed to contain ‘:’: mount::

Rules: - Exactly 3 tokens - Exactly 2 ‘:’ characters - collection_id and
folder_id MUST be valid ULIDs - Any extra ‘:’ → 400 VALIDATION

2)  TENANT ISOLATION (FROZEN)

Every domain object MUST include owner_id.

Rules: - All queries MUST filter by owner_id - Cross-tenant access
without ACL validation → REJECTED - Guessing ID MUST NOT allow access -
Absence of explicit grant = DENY

3)  SOFT DELETE MODEL (FROZEN)

deleted_at IS NOT NULL ⇒ object is logically non-existent

Rules: - All read queries MUST include deleted_at IS NULL - Restore
clears deleted_at and purge_at - Soft delete does NOT cascade via FK

4)  PERMISSION RESOLUTION (ACL) (FROZEN)

Roles: viewer, editor, admin

Resolution: If user == owner_id → FULL Else if shared via collection:
effective = role ∩ mount_access Else → DENY

Owner override ALWAYS grants full capability.

5)  OPTIMISTIC LOCKING (FROZEN)

All mutable rows MUST include version INTEGER NOT NULL.

Update rule: UPDATE … SET version = version + 1 WHERE id=? AND
owner_id=? AND version=? AND deleted_at IS NULL

If rows_affected == 0 → 409 STALE_VERSION

6)  IDEMPOTENCY (FROZEN)

All mutating endpoints MUST require X-Idempotency-Key (ULID).

Rules: - Same key + same payload → same response - Same key + different
payload → 409 IDEMPOTENCY_CONFLICT - TTL = 24h - D1 is canonical source
of truth

7)  USED_BYTES MODEL (FROZEN)

folders.used_bytes is authoritative.

Rules: - MUST NOT compute SUM(size_bytes) in request path - All
mutations must update used_bytes atomically - Reconciliation job MAY
compute SUM offline - Reconcile MUST log action=RECONCILE_USAGE

8)  UPLOAD FSM (FROZEN)

States: INITIATED COMMITTED CANCELED EXPIRED

Write Order Invariant: 1) Create upload_sessions row (status=INITIATED)
2) Create upload_session_files manifest 3) Client uploads blobs to R2 4)
COMMIT (single transaction): - Verify R2 objects exist - Insert assets
rows - Update used_bytes - Set upload_sessions.status=COMMITTED - Insert
audit_log

If verification fails: Return 409 UPLOAD_INCOMPLETE Perform NO writes to
assets or used_bytes

EXPIRED may only be set by TTL cleanup job. r2_key is write-once
immutable.

9)  R2 CONSISTENCY (FROZEN)

No COMMITTED session may exist without confirmed R2 objects.

10) AUDIT LOG (APPEND-ONLY) (FROZEN)

Allowed actions: CREATE, UPDATE, DELETE, RESTORE, PURGE, PURGE_ASSET,
RECONCILE_USAGE

Entity types: FOLDER CARD ASSET COLLECTION MEMBER MOUNT PLAN
UPLOAD_SESSION FILE

Rules: - INSERT only - No UPDATE - No DELETE (except retention purge) -
Audit insert MUST occur inside same transaction

11) CLOCK & TIME CONSISTENCY (FROZEN)

All persisted timestamps MUST use: UTC only Unix epoch milliseconds
(INTEGER) Millisecond precision

Worker MUST NOT rely on client-provided time.

12) RATE LIMIT CONTRACT (FROZEN)

All responses MUST include: X-RateLimit-Limit X-RateLimit-Remaining
X-RateLimit-Reset

429 RATE_LIMITED on exceed.

============================================================ PART II —
RESPONSE CONTRACT (FROZEN)
============================================================

Success: { “ok”: true, “data”: { … }, “contract_version”: “v7.33”,
“request_id”: “” }

Failure (ALL 4xx/5xx): { “ok”: false, “error_code”: “”, “error_message”:
“”, “contract_version”: “v7.33”, “request_id”: “” }

HTTP Mapping: 400 VALIDATION 401 AUTH_REQUIRED / AUTH_INVALID 403
FORBIDDEN 404 NOT_FOUND 409 CONFLICT / IDEMPOTENCY_CONFLICT /
STALE_VERSION / QUOTA_EXCEEDED / UPLOAD_INCOMPLETE 426 UPGRADE_REQUIRED
429 RATE_LIMITED 500 INTERNAL

============================================================ PART III —
GLOBAL INVARIANTS (FINAL LOCK)
============================================================

The following cannot change without MAJOR version bump: - ULID grammar
immutable - owner_id isolation immutable - Soft delete semantics
immutable - used_bytes authoritative - Upload FSM state model
immutable - Idempotency mandatory - Optimistic locking mandatory - Audit
append-only immutable - R2 write-order invariant immutable

END OF v7.33
